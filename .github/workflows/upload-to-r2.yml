name: Upload to R2

on:
  workflow_run:
    workflows: ["Build and Upload Artifact"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (for manual trigger)'
        required: true
        default: '1'

permissions:
  contents: read
  id-token: write # Required for OIDC
  pull-requests: write

jobs:
  upload:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download PR artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-number
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Read PR
        id: pr
        uses: juliangruber/read-file-action@v1.0.0
        with:
          path: ./pr_number.txt

      - name: Echo PR
        run: echo "${{ steps.pr.outputs.content }}"

      - name: Validate PR
        run: |
          PR_NUMBER="${{ steps.pr.outputs.content }}"
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Error: PR_NUMBER is not a valid number: $PR_NUMBER"
            exit 1
          fi
          echo "PR number validated: $PR_NUMBER"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Upload to R2
        run: |
          PR_NUMBER=${{ steps.pr.outputs.content }}
          echo "Uploading with PR_NUMBER: $PR_NUMBER"

          npx wrangler r2 object put \
            skygame-data/assets/${PR_NUMBER}-everything.json \
            --file=./everything.json --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Comment on PR
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.content }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: 'Preview: https://sandbox.sky-planner.com/?dataUrl=' + pr_number
            });
