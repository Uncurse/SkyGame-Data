name: Upload to R2

on:
  workflow_run:
    workflows: ["Build and Upload Artifact"]
    types: [completed]
    branches:
      - master
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (for manual trigger)'
        required: true
        default: '1'

permissions:
  contents: read
  id-token: write # Required for OIDC
  pull-requests: write

jobs:
  upload:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Upload to R2
        run: |
          # For workflow_run, get PR number from the HEAD branch
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          else
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          fi

          npx wrangler r2 object put \
            skygame-data/assets/${PR_NUMBER}-everything.json \
            --file=./everything.json --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Comment on PR
        if: github.event_name == 'workflow_run'
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          gh pr comment $PR_NUMBER --body "Preview: https://sandbox.sky-planner.com/?dataUrl=${PR_NUMBER}" \
            --repo ${{ github.event.workflow_run.repository.full_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
