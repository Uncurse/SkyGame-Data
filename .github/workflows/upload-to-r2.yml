name: Upload to R2

on:
  workflow_run:
    workflows: ["Build and Upload Artifact"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (for manual trigger)'
        required: true
        default: '1'

permissions:
  contents: read
  id-token: write # Required for OIDC
  pull-requests: write

jobs:
  upload:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_run') {
              const prs = context.payload.workflow_run.pull_requests;
              if (prs && prs.length > 0) {
                core.setOutput('number', prs[0].number.toString());
              } else {
                core.setFailed('No pull request associated with this workflow run.');
              }
            } else {
              core.setOutput('number', context.inputs.pr_number);
            }

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}

      - name: Upload to R2
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          echo "Uploading with PR_NUMBER: $PR_NUMBER"

          npx wrangler r2 object put \
            skygame-data/assets/${PR_NUMBER}-everything.json \
            --file=./everything.json --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Comment on PR
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: 'Preview: https://sandbox.sky-planner.com/?dataUrl=' + pr_number
            });
